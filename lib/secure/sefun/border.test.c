inherit M_TEST;

object __MockCharacter;
object query_character () {
    return __MockCharacter;
}

private nosave string __ANSI = "on", __Screenreader = "off";
private nosave int __Width = 80;
mixed query_setting (string setting) {
    if (setting == "ansi") {
        return __ANSI;
    }
    if (setting == "width") {
        return __Width;
    }
    if (setting == "screenreader") {
        return __Screenreader;
    }
}

void test_character_colors () {
    __MockCharacter = new("/std/living.c");
    __MockCharacter->set_key_name("test"); // must be named test

    expect("colors are returned", (: ({
        assert_equal(testOb->query_character_border_colors(), ({ ({ 191, 63, 191 }), ({ 63, 191, 191 }) })),

        __MockCharacter->set_class("psionist"),
        assert_equal(testOb->query_character_border_colors(), ({ ({ 65, 105, 225 }), ({ 192, 192, 192 }) })),
    }) :));
}

void test_border_charset () {
    expect("border_charset is returned", (: ({
        assert_equal(testOb->query_border_charset()["h"],  "─"),

        __Screenreader = "on",
        assert_equal(testOb->query_border_charset()["h"], " "),
        __Screenreader = "off",
    }) :));
}

void test_format_border_item () {
    expect("border header is formatted", (: ({
        assert_equal(testOb->format_border_item(([ "header": ({ "Header1", "Header2" }), "columns": 2 ]), "256", "L", "R"), ({ "L  %^RESET%^BOLD%^UNDERLINE%^Header1%^RESET%^                             %^RESET%^BOLD%^UNDERLINE%^Header2%^RESET%^                               R" })),
        assert_equal(testOb->format_border_item(([ "header": ({ "A123456789", "B123456789", "C123456789", "D123456789", "E123456789", "F123456789", "G123456789", "H123456789", "I123456789", "J123456789", "K123456789", "L123456789" }), "columns": 10 ]), "256", "L", "R"), ({ "L  A123456B123456C123456D123456E123456F123456G123456H123456I123456J123456    R" })),
    }) :));
    expect("border item is formatted", (: ({
        assert_equal(__Width = 20, 20),
        assert_equal(testOb->format_border_item(([ "items": ({ "1", "2", "3", }) ]), "256", "L", "R"), ({  "L  1     2       R", "L  3             R" })),

        assert_equal(__Width = 40, 40),
        assert_equal(testOb->format_border_item(([ "items": ({ "1", "2", "3", }) ]), "256", "L", "R"), ({ "L  1               2                 R", "L  3                                 R" })),
    }) :));
}

void test_format_border () {
    mapping data = ([
        "header": ([
            "header": ({ "Header Header 1", "Header Header 2", "Header Header 3", "Header Header 4", }),
            "items": ({ "Header Item 1", "Header Item 2", "Header Item 3", "Header Item 4", }),
            "columns": 4,
            "align": "center",
        ]),
        "body": ([
            "header": ({ "Body Header 1", "Body Header 2", "Body Header 3", "Body Header 4", }),
            "items": ({ "Body Item 1", "Body Item 2", "Body Item 3", "Body Item 4", }),
            "columns": 4,
            "align": "center",
        ]),
        "footer": ([
            "header": ({ "Footer Header 1", "Footer Header 2", "Footer Header 3", "Footer Header 4", }),
            "items": ({ "Footer Item 1", "Footer Item 2", "Footer Item 3", "Footer Item 4", }),
            "columns": 4,
            "align": "center",
        ]),
    ]);
    expect("border is formatted", (: ({
        assert_equal(__Width, 40),
        assert_equal(testOb->format_border($(data), testOb->query_border_charset(), __Width, 0), ({
            "╭┬────────────────────────────────────┬╮",
            "││  Header HHeader HHeader HHeader H  ││",
            "││  Header IHeader IHeader IHeader I  ││",
            "│╰────────────────────────────────────╯│",
            "│                                      │",
            "│   Body HeaBody HeaBody HeaBody Hea   │",
            "│   Body IteBody IteBody IteBody Ite   │",
            "│                                      │",
            "│╭────────────────────────────────────╮│",
            "││  Footer HFooter HFooter HFooter H  ││",
            "││  Footer IFooter IFooter IFooter I  ││",
            "╰┴────────────────────────────────────┴╯"
        })),
        assert_equal(testOb->format_border($(data), testOb->query_border_charset(), __Width, "16"), ({
            "\e[36m╭┬────────────────────────────────────┬╮\e[0;37;40m",
            "\e[36m││\e[0;37;40m  Header HHeader HHeader HHeader H  \e[36m││\e[0;37;40m",
            "\e[36m││\e[0;37;40m  Header IHeader IHeader IHeader I  \e[36m││\e[0;37;40m",
            "\e[36m│╰────────────────────────────────────╯│\e[0;37;40m",
            "\e[36m│\e[0;37;40m                                      \e[36m│\e[0;37;40m",
            "\e[36m│\e[0;37;40m   Body HeaBody HeaBody HeaBody Hea   \e[36m│\e[0;37;40m",
            "\e[36m│\e[0;37;40m   Body IteBody IteBody IteBody Ite   \e[36m│\e[0;37;40m",
            "\e[36m│\e[0;37;40m                                      \e[36m│\e[0;37;40m",
            "\e[36m│╭────────────────────────────────────╮│\e[0;37;40m",
            "\e[36m││\e[0;37;40m  Footer HFooter HFooter HFooter H  \e[36m││\e[0;37;40m",
            "\e[36m││\e[0;37;40m  Footer IFooter IFooter IFooter I  \e[36m││\e[0;37;40m",
            "\e[36m╰┴────────────────────────────────────┴╯\e[0;37;40m"
        })),
        assert_equal(testOb->format_border($(data), testOb->query_border_charset(), __Width, "256"), ({
            "\e[38;2;64;106;229m╭\e[38;2;71;109;227m┬\e[38;2;78;112;225m─\e[38;2;83;115;223m─\e[38;2;88;117;221m─\e[38;2;93;120;219m─\e[38;2;97;122;218m─\e[38;2;101;124;216m─\e[38;2;105;126;214m─\e[38;2;109;128;213m─\e[38;2;112;130;211m─\e[38;2;115;132;210m─\e[38;2;118;134;208m─\e[38;2;121;136;206m─\e[38;2;124;138;205m─\e[38;2;127;140;203m─\e[38;2;129;141;202m─\e[38;2;132;143;200m─\e[38;2;134;144;199m─\e[38;2;136;146;197m─\e[38;2;138;148;196m─\e[38;2;141;149;195m─\e[38;2;143;150;193m─\e[38;2;145;152;192m─\e[38;2;147;153;190m─\e[38;2;149;155;189m─\e[38;2;150;156;188m─\e[38;2;152;157;186m─\e[38;2;154;158;185m─\e[38;2;156;160;184m─\e[38;2;157;161;182m─\e[38;2;159;162;181m─\e[38;2;161;163;180m─\e[38;2;162;165;179m─\e[38;2;164;166;177m─\e[38;2;165;167;176m─\e[38;2;167;168;175m─\e[38;2;168;169;174m─\e[38;2;170;170;172m┬\e[38;2;171;171;171m╮\e[0;37;40m",
            "\e[38;2;86;116;222m││\e[0;37;40m  Header HHeader HHeader HHeader H  \e[38;2;166;167;176m││\e[0;37;40m",
            "\e[38;2;102;124;216m││\e[0;37;40m  Header IHeader IHeader IHeader I  \e[38;2;161;163;180m││\e[0;37;40m",
            "\e[38;2;113;130;208m│\e[38;2;114;131;207m╰\e[38;2;116;132;206m─\e[38;2;117;133;205m─\e[38;2;118;133;205m─\e[38;2;119;134;204m─\e[38;2;120;135;203m─\e[38;2;121;135;202m─\e[38;2;122;136;202m─\e[38;2;123;136;201m─\e[38;2;124;137;200m─\e[38;2;125;138;200m─\e[38;2;126;138;199m─\e[38;2;127;139;198m─\e[38;2;128;140;197m─\e[38;2;129;140;197m─\e[38;2;130;141;196m─\e[38;2;131;141;195m─\e[38;2;132;142;194m─\e[38;2;133;143;194m─\e[38;2;134;143;193m─\e[38;2;135;144;192m─\e[38;2;136;144;191m─\e[38;2;137;145;191m─\e[38;2;137;145;190m─\e[38;2;138;146;189m─\e[38;2;139;147;188m─\e[38;2;140;147;188m─\e[38;2;141;148;187m─\e[38;2;142;148;186m─\e[38;2;142;149;185m─\e[38;2;143;149;185m─\e[38;2;144;150;184m─\e[38;2;145;150;183m─\e[38;2;146;151;182m─\e[38;2;146;151;182m─\e[38;2;147;152;181m─\e[38;2;148;152;180m─\e[38;2;149;153;179m╯\e[38;2;149;153;179m│\e[0;37;40m",
            "\e[38;2;124;138;205m│\e[0;37;40m                                      \e[38;2;148;154;189m│\e[0;37;40m",
            "\e[38;2;133;144;199m│\e[0;37;40m   Body HeaBody HeaBody HeaBody Hea   \e[38;2;141;149;194m│\e[0;37;40m",
            "\e[38;2;141;149;194m│\e[0;37;40m   Body IteBody IteBody IteBody Ite   \e[38;2;133;144;199m│\e[0;37;40m",
            "\e[38;2;148;154;189m│\e[0;37;40m                                      \e[38;2;124;138;205m│\e[0;37;40m",
            "\e[38;2;149;153;179m│\e[38;2;149;153;179m╭\e[38;2;148;152;180m─\e[38;2;147;152;181m─\e[38;2;146;151;182m─\e[38;2;146;151;182m─\e[38;2;145;150;183m─\e[38;2;144;150;184m─\e[38;2;143;149;185m─\e[38;2;142;149;185m─\e[38;2;142;148;186m─\e[38;2;141;148;187m─\e[38;2;140;147;188m─\e[38;2;139;147;188m─\e[38;2;138;146;189m─\e[38;2;137;145;190m─\e[38;2;137;145;191m─\e[38;2;136;144;191m─\e[38;2;135;144;192m─\e[38;2;134;143;193m─\e[38;2;133;143;194m─\e[38;2;132;142;194m─\e[38;2;131;141;195m─\e[38;2;130;141;196m─\e[38;2;129;140;197m─\e[38;2;128;140;197m─\e[38;2;127;139;198m─\e[38;2;126;138;199m─\e[38;2;125;138;200m─\e[38;2;124;137;200m─\e[38;2;123;136;201m─\e[38;2;122;136;202m─\e[38;2;121;135;202m─\e[38;2;120;135;203m─\e[38;2;119;134;204m─\e[38;2;118;133;205m─\e[38;2;117;133;205m─\e[38;2;116;132;206m─\e[38;2;114;131;207m╮\e[38;2;113;130;208m│\e[0;37;40m",
            "\e[38;2;161;163;180m││\e[0;37;40m  Footer HFooter HFooter HFooter H  \e[38;2;102;124;216m││\e[0;37;40m",
            "\e[38;2;166;167;176m││\e[0;37;40m  Footer IFooter IFooter IFooter I  \e[38;2;86;116;222m││\e[0;37;40m",
            "\e[38;2;171;171;171m╰\e[38;2;170;170;172m┴\e[38;2;168;169;174m─\e[38;2;167;168;175m─\e[38;2;165;167;176m─\e[38;2;164;166;177m─\e[38;2;162;165;179m─\e[38;2;161;163;180m─\e[38;2;159;162;181m─\e[38;2;157;161;182m─\e[38;2;156;160;184m─\e[38;2;154;158;185m─\e[38;2;152;157;186m─\e[38;2;150;156;188m─\e[38;2;149;155;189m─\e[38;2;147;153;190m─\e[38;2;145;152;192m─\e[38;2;143;150;193m─\e[38;2;141;149;195m─\e[38;2;138;148;196m─\e[38;2;136;146;197m─\e[38;2;134;144;199m─\e[38;2;132;143;200m─\e[38;2;129;141;202m─\e[38;2;127;140;203m─\e[38;2;124;138;205m─\e[38;2;121;136;206m─\e[38;2;118;134;208m─\e[38;2;115;132;210m─\e[38;2;112;130;211m─\e[38;2;109;128;213m─\e[38;2;105;126;214m─\e[38;2;101;124;216m─\e[38;2;97;122;218m─\e[38;2;93;120;219m─\e[38;2;88;117;221m─\e[38;2;83;115;223m─\e[38;2;78;112;225m─\e[38;2;71;109;227m┴\e[38;2;64;106;229m╯\e[0;37;40m"
        })),
        assert_equal(testOb->format_border($(data) + ([ "borderColors": ({ ({ 65, 105, 225 }), ({ 65, 105, 225 }) }) ]), testOb->query_border_charset(), __Width, "256"), ({
            "\e[38;2;64;106;229m╭\e[38;2;64;106;229m┬\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m┬\e[38;2;64;106;229m╮\e[0;37;40m",
            "\e[38;2;64;106;229m││\e[0;37;40m  Header HHeader HHeader HHeader H  \e[38;2;64;106;229m││\e[0;37;40m",
            "\e[38;2;64;106;229m││\e[0;37;40m  Header IHeader IHeader IHeader I  \e[38;2;64;106;229m││\e[0;37;40m",
            "\e[38;2;63;105;231m│\e[38;2;63;105;231m╰\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m╯\e[38;2;63;105;231m│\e[0;37;40m",
            "\e[38;2;64;106;229m│\e[0;37;40m                                      \e[38;2;64;106;229m│\e[0;37;40m",
            "\e[38;2;64;106;229m│\e[0;37;40m   Body HeaBody HeaBody HeaBody Hea   \e[38;2;64;106;229m│\e[0;37;40m",
            "\e[38;2;64;106;229m│\e[0;37;40m   Body IteBody IteBody IteBody Ite   \e[38;2;64;106;229m│\e[0;37;40m",
            "\e[38;2;64;106;229m│\e[0;37;40m                                      \e[38;2;64;106;229m│\e[0;37;40m",
            "\e[38;2;63;105;231m│\e[38;2;63;105;231m╭\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m─\e[38;2;63;105;231m╮\e[38;2;63;105;231m│\e[0;37;40m",
            "\e[38;2;64;106;229m││\e[0;37;40m  Footer HFooter HFooter HFooter H  \e[38;2;64;106;229m││\e[0;37;40m",
            "\e[38;2;64;106;229m││\e[0;37;40m  Footer IFooter IFooter IFooter I  \e[38;2;64;106;229m││\e[0;37;40m",
            "\e[38;2;64;106;229m╰\e[38;2;64;106;229m┴\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m─\e[38;2;64;106;229m┴\e[38;2;64;106;229m╯\e[0;37;40m"
        })),
    }) :));
}

/*


*/

void test_tree () {
    expect("tree behaves", (: ({
        assert_equal(testOb->tree(([ "00": "abcdefghi", "01": "abcdefghi" ])), ({ "0. 00abcdefghi", "1. 01abcdefghi" })),
        assert_equal(testOb->tree(([ "A": ([ "1": ([ "a": ([ ]), "b": ([ ]) ]), "2": ([ ]), ]), "B": ([ ]), "C": ([ "1": ([ ]), "2": ([ "a": ([ ]), "b": ([ ]) ]) ]) ]), ), ({  "0. A", "├─0. 1", "│ ├─0. a", "│ └─1. b", "└─1. 2", "1. B", "2. C", "├─0. 1", "└─1. 2", "  ├─0. a", "  └─1. b" })),

        assert_catch((: testOb->tree(UNDEFINED) :), "*Bad argument 1 to border->tree\n"),
    }) :));
}